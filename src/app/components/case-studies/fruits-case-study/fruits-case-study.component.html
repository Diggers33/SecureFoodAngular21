<div class="case-study-page">
  <div class="page-container">
    <!-- Back Button -->
    <div class="mb-6">
      <button class="back-button" (click)="onBackToUseCases()">
        <lucide-icon name="arrow-left"></lucide-icon>
        <span>{{ 'buttons.backToUseCases' | translate }}</span>
      </button>
    </div>

    <!-- Header -->
    <div class="header-section">
      <div class="header-icon fruits-icon">
        <lucide-icon name="apple"></lucide-icon>
      </div>
      <div>
        <h1 class="page-title">Fruits & Vegetables <span class="text-green">Dashboard</span></h1>
        <p class="page-subtitle-text">Fruits & Vegetables - Portugal</p>
      </div>
    </div>

    <p class="description-text">
      Interactive visualization of the Portuguese fresh produce supply chain - hover over nodes for details
    </p>

    <!-- Supply Chain Diagram -->
    <div class="diagram-card">
      <!-- Zoom Controls -->
      <div class="zoom-controls">
        <button class="zoom-btn" (click)="zoomIn()" [disabled]="zoom >= 1.5" title="Zoom In">
          <lucide-icon name="zoom-in"></lucide-icon>
        </button>
        <button class="zoom-btn" (click)="zoomOut()" [disabled]="zoom <= 0.5" title="Zoom Out">
          <lucide-icon name="zoom-out"></lucide-icon>
        </button>
        <button class="zoom-btn" (click)="resetZoom()" title="Reset Zoom">
          <lucide-icon name="maximize-2"></lucide-icon>
        </button>
        <span class="zoom-level">{{ getZoomPercent() }}%</span>
      </div>

      <div class="diagram-container" [style.transform]="'scale(' + zoom + ')'" [style.width]="(100 / zoom) + '%'">
        <!-- SVG Connections -->
        <svg class="connections-svg">
          <defs>
            <marker id="arrowhead-fruit" markerWidth="10" markerHeight="10" refX="9" refY="5" orient="auto">
              <path d="M0,0 L0,10 L10,5 z" fill="#14b8a6" />
            </marker>
            <marker id="arrowhead-fruit-active" markerWidth="12" markerHeight="12" refX="10" refY="6" orient="auto">
              <path d="M0,0 L0,12 L12,6 z" fill="#0d9488" />
            </marker>
          </defs>
          @for (conn of connections; track $index) {
            <path
              [attr.d]="getConnectionPath(conn)"
              [attr.stroke]="isConnectionHighlighted(conn.from, conn.to) ? '#0d9488' : '#14b8a6'"
              [attr.stroke-width]="getConnectionStrokeWidth(conn)"
              [attr.opacity]="getConnectionOpacity(conn)"
              fill="none"
              stroke-linecap="round"
              stroke-linejoin="round"
              [attr.marker-end]="isConnectionHighlighted(conn.from, conn.to) ? 'url(#arrowhead-fruit-active)' : 'url(#arrowhead-fruit)'"
            />
          }
        </svg>

        <!-- Nodes -->
        @for (node of nodes; track node.id) {
          <div
            class="supply-node"
            [style.left.px]="node.position.x"
            [style.top.px]="node.position.y"
            (mouseenter)="onNodeHover(node.id)"
            (mouseleave)="onNodeHover(null)"
            (click)="onNodeClick(node.id)"
          >
            <div class="node-icon-wrapper" [class.highlighted]="selectedNode === node.id">
              <lucide-icon [name]="node.icon"></lucide-icon>
              @if (selectedNode === node.id) {
                <div class="node-glow"></div>
              }
            </div>
            <p class="node-label" [class.highlighted]="selectedNode === node.id">{{ node.label }}</p>

            <!-- Tooltip -->
            @if (hoveredNode === node.id || selectedNode === node.id) {
              <div class="node-tooltip" [class.expanded]="selectedNode === node.id" (click)="$event.stopPropagation()">
                <div class="tooltip-header">
                  <div>
                    <p class="tooltip-title">{{ node.label }}</p>
                    <p class="tooltip-desc">{{ node.description }}</p>
                  </div>
                  @if (selectedNode === node.id) {
                    <button class="close-btn" (click)="closeNodeDetail($event)">&times;</button>
                  }
                </div>

                <!-- Compact KPIs (when not expanded) -->
                @if (selectedNode !== node.id) {
                  <div class="kpi-list compact">
                    @for (kpi of node.kpis.slice(0, 3); track kpi.name) {
                      <div class="kpi-row">
                        <span class="kpi-name">{{ kpi.name }}</span>
                        <div class="kpi-value-wrap">
                          <span class="kpi-val">{{ kpi.value }}</span>
                          @if (kpi.trend === 'up') {
                            <lucide-icon name="trending-up" class="trend-up"></lucide-icon>
                          } @else if (kpi.trend === 'down') {
                            <lucide-icon name="trending-down" class="trend-down"></lucide-icon>
                          } @else {
                            <span class="trend-stable"></span>
                          }
                        </div>
                      </div>
                    }
                  </div>
                  <p class="click-hint">Click to view detailed metrics</p>
                }

                <!-- Expanded KPIs and Metrics -->
                @if (selectedNode === node.id) {
                  <div class="kpi-list expanded">
                    @for (kpi of node.kpis; track kpi.name) {
                      <div class="kpi-row-expanded">
                        <span class="kpi-name">{{ kpi.name }}</span>
                        <div class="kpi-value-wrap">
                          <span class="kpi-val">{{ kpi.value }}</span>
                          @if (kpi.trend === 'up') {
                            <lucide-icon name="trending-up" class="trend-up"></lucide-icon>
                          } @else if (kpi.trend === 'down') {
                            <lucide-icon name="trending-down" class="trend-down"></lucide-icon>
                          } @else {
                            <span class="trend-stable"></span>
                          }
                        </div>
                      </div>
                    }
                  </div>

                  @if (node.metrics) {
                    <div class="metrics-section-tooltip">
                      <p class="metrics-title">Performance Metrics</p>
                      <div class="metrics-grid">
                        <div class="metric-box teal">
                          <p class="metric-label">Throughput</p>
                          <p class="metric-value">{{ node.metrics.throughput }}</p>
                        </div>
                        <div class="metric-box gray">
                          <p class="metric-label">Efficiency</p>
                          <p class="metric-value">{{ node.metrics.efficiency }}</p>
                        </div>
                        <div class="metric-box teal">
                          <p class="metric-label">Quality</p>
                          <p class="metric-value">{{ node.metrics.quality }}</p>
                        </div>
                        <div class="metric-box gray">
                          <p class="metric-label">Cost</p>
                          <p class="metric-value">{{ node.metrics.cost }}</p>
                        </div>
                      </div>
                    </div>
                  }
                }

                <div class="tooltip-arrow"></div>
              </div>
            }
          </div>
        }
      </div>
    </div>

    <!-- Metric Cards -->
    <div class="metric-cards-grid">
      <div class="metric-card blue">
        <div class="metric-card-content">
          <div>
            <p class="metric-card-label">Cold Chain Temp</p>
            <p class="metric-card-value">3.2Â°C</p>
          </div>
          <div class="metric-card-icon blue">
            <lucide-icon name="thermometer"></lucide-icon>
          </div>
        </div>
        <div class="metric-card-trend green">
          <lucide-icon name="trending-down"></lucide-icon>
          <span>Optimal range</span>
        </div>
      </div>

      <div class="metric-card orange">
        <div class="metric-card-content">
          <div>
            <p class="metric-card-label">Avg Delay</p>
            <p class="metric-card-value">11.4h</p>
          </div>
          <div class="metric-card-icon orange">
            <lucide-icon name="clock"></lucide-icon>
          </div>
        </div>
        <div class="metric-card-trend orange">
          <lucide-icon name="trending-up"></lucide-icon>
          <span>+8% vs target</span>
        </div>
      </div>

      <div class="metric-card teal">
        <div class="metric-card-content">
          <div>
            <p class="metric-card-label">Freshness Score</p>
            <p class="metric-card-value">94</p>
          </div>
          <div class="metric-card-icon teal">
            <lucide-icon name="apple"></lucide-icon>
          </div>
        </div>
        <div class="metric-card-trend green">
          <lucide-icon name="trending-up"></lucide-icon>
          <span>+2% this week</span>
        </div>
      </div>

      <div class="metric-card emerald">
        <div class="metric-card-content">
          <div>
            <p class="metric-card-label">Waste Rate</p>
            <p class="metric-card-value">5.2%</p>
          </div>
          <div class="metric-card-icon emerald">
            <lucide-icon name="trending-down"></lucide-icon>
          </div>
        </div>
        <div class="metric-card-trend green">
          <lucide-icon name="trending-down"></lucide-icon>
          <span>-12% this month</span>
        </div>
      </div>
    </div>

    <!-- Trend Charts -->
    <div class="charts-grid">
      <div class="chart-card blue">
        <h3 class="chart-title blue">Cold Chain Temperature Trend</h3>
        <div echarts [options]="tempChartOption" class="chart"></div>
      </div>

      <div class="chart-card orange">
        <h3 class="chart-title orange">Logistics Delay Trend</h3>
        <div echarts [options]="logisticsChartOption" class="chart"></div>
      </div>

      <div class="chart-card emerald">
        <h3 class="chart-title emerald">Waste Reduction Trend</h3>
        <div echarts [options]="wasteChartOption" class="chart"></div>
      </div>
    </div>

    <!-- Info Cards -->
    <div class="route-cards-grid">
      <div class="route-card teal">
        <div class="route-icon teal">
          <lucide-icon name="apple"></lucide-icon>
        </div>
        <div class="route-content">
          <h3 class="route-title">Portugal Focus</h3>
          <p class="route-desc">This case study focuses on the Portuguese fruits and vegetables supply chain, analyzing logistics efficiency, cold chain management, and distribution optimization from farm to consumer.</p>
          <span class="route-badge teal">
            <span class="badge-dot"></span>
            Fresh Produce
          </span>
        </div>
      </div>

      <div class="route-card slate">
        <div class="route-icon slate">
          <lucide-icon name="truck"></lucide-icon>
        </div>
        <div class="route-content">
          <h3 class="route-title">Cold Chain Critical</h3>
          <p class="route-desc">Fresh produce requires rapid transport, temperature control, and careful handling at each stage to maintain quality and minimize waste throughout the entire supply chain.</p>
          <span class="route-badge slate">
            <span class="badge-dot"></span>
            Quality Assurance
          </span>
        </div>
      </div>
    </div>
  </div>
</div>
